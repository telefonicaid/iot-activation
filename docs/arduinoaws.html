<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width initial-scale=1">

  <title>Arduino to AWS</title>
  <meta name="description" content="Table of Contents">
  <meta name="google-translate-customization" content="b9870a0c7376df54-aa35852016e6a5cc-ga0a0d80f6c171f17-e"></meta>
  <link rel="stylesheet" href="css/main.css">
  <link rel="canonical" href="http://localhost:4000/ArduinoAWS.html">
  <link href="/favicon.png" rel="icon">
  <!--link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"-->
  <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="alternate" type="application/atom+xml" title="IoT Activation" href="http://localhost:4000/atom.xml" />
</head>


  <body>
         <div class="col-md-12 navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-inverse-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/iot-activation/">IoT Activation</a>
      </div>
      <div class="navbar-collapse collapse navbar-inverse-collapse">
        <ul class="nav navbar-nav">
          
            
          
            
              <!-- li><a href="/about.html">About</a></li-->
            
          
            
          
            
          
          
<!--           <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Pages<b class="caret"></b></a>
            <ul class="dropdown-menu">
            
              
            
              
                <li><a href="/about.html" style="text-transform : uppercase;">About</a></li>
              
            
              
            
              
            
            </ul>
          </li>
 -->        </ul>
       
        <ul class="nav navbar-nav navbar-right left-syms">
          <li><a href="https://iot.telefonica.com/blog" target="_blank"><i class="fa fa-rss"></i> <span>Blog</span></a></li>
          <li><a href="https://www.linkedin.com/showcase/telefonicaiot/" target="_blank"><i class="fa fa-linkedin"></i> <span>linkedin</span></a></li>
          <li><a href="//twitter.com/TelefonicaIoT" target="_blank"><i class="fa fa-twitter"></i> <span>Twitter</span></a></li>
          <li><a href="https://www.youtube.com/user/m2mtelefonica/featured" target="_blank"><i class="fa fa-youtube"></i> <span>Youtube</span></a></li>
          <li><a href="http://github.com/telefonicaid/iot-activation" target="_blank"><i class="fa fa-github"></i> <span>Github</span></a></li>
        </ul>
      </div>
    </div>


    <div class="col-md-12 blog-theme-class">
          <!-- Top Blog Header -->
          <div class="row jumb-bot">
            <div class="col-md-1"></div>
            <div class="jumbotron jumb-bot-jumbu col-md-10">

              <h1>IoT Activation</h1>
              <p>Welcome to the Revolu<strong>IOT</strong>n</p>
            </div>            
            <div class="col-md-1"></div>
          </div>
    </div>
    <div class="col-md-12">
        <div class="row">
	<div class="col-md-1"></div>
	<div class="col-md-10">

	  	
	    <h1>Arduino to AWS</h1>
	    <!--<div id="google_translate_element" style="padding-right: 27px;float: left;"></div><script type="text/javascript">
			function googleTranslateElementInit() {
  				new google.translate.TranslateElement({pageLanguage: 'en', layout: google.translate.TranslateElement.InlineLayout.SIMPLE}, 'google_translate_element');
				}
		</script><script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
		-->
	    <p class="post-meta">Feb 6, 2019</p>

	   
	  	<article class="blog-post-small blog-post-content">
	    	<h3 id="table-of-contents">Table of Contents</h3>

<ul>
  <li><a href="#arduino-mkr-nb-1500-to-aws-iot">Arduino: MKR NB-1500 to AWS-IoT</a>
    <ul>
      <li><a href="#getting-started-with-the-mkr-nb-1500">Getting started with the MKR NB-1500</a>
        <ul>
          <li><a href="#what-will-you-learn">What will you learn?</a></li>
          <li><a href="#what-will-you-need">What will you need?</a></li>
        </ul>
      </li>
      <li><a href="#create-a-device-thing-in-aws-iot">Create a device thing in AWS-IoT</a></li>
      <li><a href="#what-is-mqtt">What is MQTT</a></li>
      <li><a href="#how-to-communicate-with-aws">How to communicate with AWS</a></li>
      <li><a href="#test-your-certificates-with-mqttfx">Test your Certificates with MQTT.fx</a></li>
    </ul>
  </li>
  <li><a href="#how-to-start-with-the-project">How to Start with the project</a>
    <ul>
      <li><a href="#arduino-board-run-a-code-file">Arduino Board: Run a code file</a></li>
      <li><a href="#udp-data-bridge-connecting-using-nb-iot-o-lte-m">UDP data Bridge: Connecting using NB-IoT o LTE-M</a></li>
      <li><a href="#check-the-shadow">Check the Shadow</a></li>
      <li><a href="#send-a-command">Send a command</a></li>
    </ul>
  </li>
</ul>

<h1 id="arduino-mkr-nb-1500-to-aws-iot">Arduino: MKR NB-1500 to AWS-IoT</h1>

<p>For this project, we‚Äôre going to use a Arduino board to take measures and publish their values in AWS.
You will also be able to send commands for turn the board led on/off.</p>

<p align="center">
	  <img title="Project_ard" src="pictures/schematics/overview_arduino_AWS.png" href="docs/ArduinoAWS.html" />
</p>

<h2 id="getting-started-with-the-mkr-nb-1500">Getting started with the MKR NB-1500</h2>

<p>The Arduino MKR NB 1500 adds wireless connectivity, Narrow Band IoT and LTE CAT M1, to the Arduino family. 
It is a  development board which contains the ATMEL SAMD21 micro controller, 
designed to integrate a low power-consumption core and a high performance.</p>

<h4 id="what-will-you-learn-">What will you learn ?</h4>

<ul>
  <li>Control Arduino board MKR NB-1500 using the Arduino IDE</li>
  <li>Register a device on AWS</li>
  <li>Generate credentials for AWS</li>
  <li>Take measurements</li>
  <li>Build a bridge between UDP and AWS</li>
  <li>Send commands to the device</li>
</ul>

<h4 id="what-will-you-need">What will you need?</h4>

<ul>
  <li>Have successfully completed the Arduino <a href="ArduinoStarterKit.html">Starterkit tutorial</a></li>
  <li>Arduino board MKR NB-1500</li>
  <li>Micro USB cable</li>
  <li>Arduino IDE</li>
  <li>AWS account</li>
  <li>Telef√≥nica SIMs with private APN <a href="BPIPsec.html">(IPsec)</a></li>
  <li><a href="KitePlatform.html#access-step-by-step-using-the-curl-command">KITE Platform</a> Certificates files</li>
  <li>Telef√≥nica <a href="BPDataBridge.html">data Bridge</a></li>
</ul>

<p>If you had successfully completed the Arduino Starterkit tutorial, all the necessary software is already updated.</p>

<p><a href="#table-of-contents"><img src="pictures/utils/arrow_up.png" alt="pic" /></a></p>

<h2 id="create-a-device-thing-in-aws-iot">Create a device thing in AWS-IoT</h2>

<ol>
  <li>
    <p>Sign in to the AWS Management Console, and then open the AWS IoT console at https://console.aws.amazon.com/iot</p>
  </li>
  <li>
    <p>Go to the Monitor page. In the left navigation panel, choose Manage, and then choose Things.</p>
  </li>
</ol>

<p><img src="pictures/AWS/AWS_Console.png" alt="pic" /></p>

<ol>
  <li>You don‚Äôt have a thing created yet. Choose Register a thing.</li>
</ol>

<p><img src="pictures/AWS/AWS_Console_Manage_Register.png" alt="pic" /></p>

<ol>
  <li>On the Creating AWS IoT things page, choose Create a single thing.</li>
</ol>

<p><img src="pictures/AWS/AWS_Console_Manage_Register_things.png" alt="pic" /></p>

<ol>
  <li>Enter a name for the device, leave the default values for all the other fields, and then choose Next.</li>
</ol>

<p><img src="pictures/AWS/AWS_Console_Manage_Register_Device.png" alt="pic" /></p>

<ol>
  <li>Now you should generate the certificates.</li>
</ol>

<p><img src="pictures/AWS/AWS_Console_Manage_Certificates.png" alt="pic" /></p>

<ol>
  <li>Download your public and private keys, certificate, and root certificate authority (CA)on your PC.</li>
</ol>

<p><img src="pictures/AWS/AWS_Console_Manage_Certificates_Download.png" alt="pic" /></p>

<ol>
  <li>Download your root certificate authority, a new window will open for select a CA to download.</li>
</ol>

<p><img src="pictures/AWS/AWS_Console_Manage_Certificates_Download_CA.png" alt="pic" /></p>

<ol>
  <li>
    <p>Don‚Äôt forget to save these files, you need them to set the connection</p>
  </li>
  <li>
    <p>Returns to the previous window and <strong>Activate</strong></p>
  </li>
  <li>
    <p>Select <strong>Attach a policy</strong></p>
  </li>
</ol>

<p><img src="pictures/AWS/AWS_Console_Manage_Certificates_Download.png" alt="pic" /></p>

<ol>
  <li>Close this window. Before, you need to create and attach a new policy to the certificate</li>
</ol>

<p><img src="pictures/AWS/AWS_Console_Manage_Certificates_AttachPolicy.png" alt="pic" /></p>

<ol>
  <li>
    <p>Open the AWS IoT console again https://console.aws.amazon.com/iot</p>
  </li>
  <li>
    <p>In the left navigation panel, choose <strong>Secure</strong>, and then choose <strong>Policies</strong>.</p>
  </li>
  <li>
    <p>Select <strong>Create a Policy</strong></p>
  </li>
</ol>

<p><img src="pictures/AWS/AWS_Console_Secure_Policies.png" alt="pic" /></p>

<ol>
  <li>Enter a Name for the policy:
    <ul>
      <li><strong>Action</strong>        enter <strong>iot:</strong>*</li>
      <li><strong>Resource ARN</strong>  enter <strong>*</strong></li>
      <li><strong>Effect</strong>        choose <strong>Allow</strong>
Select Create. This policy allows your Device to publish messages to AWS IoT.</li>
    </ul>
  </li>
</ol>

<p><img src="pictures/AWS/AWS_Console_Secure_Policies_Create_Device.png" alt="pic" /></p>

<ol>
  <li>In the AWS IoT console, choose <strong>Manage</strong>, <strong>Things</strong>. On the Things page, choose your Thing</li>
</ol>

<p><img src="pictures/AWS/AWS_Console_Manage_Things_Device.png" alt="pic" /></p>

<ol>
  <li>On the thing‚Äôs <strong>Details</strong> page, in the left navigation panel, choose <strong>Interact</strong>.
Make a note of the REST API endpoint. You need it to connect to your device shadow.</li>
</ol>

<p><img src="pictures/AWS/AWS_Console_Manage_Things_Details_Interact_Device.png" alt="pic" /></p>

<ol>
  <li>Now select <strong>Security</strong>, and choose the certificate that you created earlier.</li>
</ol>

<p><img src="pictures/AWS/AWS_Console_Manage_Things_Details_Security_Device.png" alt="pic" /></p>

<ol>
  <li>In Actions, choose Attach policy</li>
</ol>

<p><img src="pictures/AWS/AWS_Console_Manage_Things_Details_Security_Policy_Device.png" alt="pic" /></p>

<ol>
  <li>Select your new policy and then choose Attach</li>
</ol>

<p><img src="pictures/AWS/AWS_Console_Manage_Things_Details_Security_Policy_Attach_Device.png" alt="pic" /></p>

<p><a href="#table-of-contents"><img src="pictures/utils/arrow_up.png" alt="pic" /></a></p>

<h2 id="what-is-mqtt">What is MQTT</h2>
<p>MQTT is a machine-to-machine (M2M)/‚ÄùInternet of Things‚Äù connectivity protocol.
It was designed as an extremely lightweight publish/subscribe messaging transport.</p>

<p>The first concept is the publish and subscribe system.
A device can publish a message on a topic,
or it can be subscribed to a topic to receive messages</p>

<p>AWS use this system to communicate with your devices.</p>

<p>Access to IoT Core in AWS Management Console and go to the left navigation pane. Select Manage, and then choose Things.</p>

<p>When you pick a thing you can find out the different topic that you can subscribe/publish</p>

<p>Select <strong>Interact</strong> to inspect them.</p>

<p>üìç
Don‚Äôt forget to copy also the Rest API, you will need it as a broker address.</p>

<p><img src="pictures/AWS/AWS_Console_Manage_Things_Details_Interact_MQTT_Device.png" alt="pic" /></p>

<p>At the moment, you only need to know three topics:</p>
<ul>
  <li>Publish in this topic to update the thing shadow
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$aws/things/MyDevice/shadow/update
</code></pre></div>    </div>
  </li>
  <li>Subscribe to this topic to check if the report was accepted
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$aws/things/MyDevice/shadow/update/accepted
</code></pre></div>    </div>
  </li>
  <li>Subscribe to this topic to check if the report was rejected
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$aws/things/MyDevice/shadow/update/rejected
</code></pre></div>    </div>
  </li>
</ul>

<p><a href="#table-of-contents"><img src="pictures/utils/arrow_up.png" alt="pic" /></a></p>

<h2 id="how-to-communicate-with-aws">How to communicate with AWS</h2>

<p>As you know, when you register a new device in AWS, his reserved Topics are created by default,
You can use these topics for send data and receive information from the shadow.</p>

<p>For the time being, you only need to know a couple of them:</p>

<ul>
  <li>topic Update
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$aws/things/MyDevice/shadow/update
</code></pre></div>    </div>
    <p>this topic is where you publish the status of the device for update the shadow,
in this tutorial this information is composed of values sent by the Arduino with the label <strong>reported</strong></p>
  </li>
</ul>

<p>You‚Äôll also use the topic to communicate the desires to the shadow.
You must publish in the shadow like the Arduion, but using the label <strong>desired.</strong>
In this case we use MQTT.fx to communicate these desires to AWS and to report the change to the device.</p>

<ul>
  <li>topic Delta
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$aws/things/MyDevice/shadow/update/delta
</code></pre></div>    </div>
    <p>This is the channel that AWS uses to communicate to the device 
the difference between the reported status and the desired status.
It is necessary that the device is subscribed to the topic.</p>
  </li>
</ul>

<p>All these status are recorded in the <strong>shadow</strong> of the device. 
To check the current status, you should access the AWS IoT core as we taught you at the previous section.</p>

<p>Here you have an example:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"desired"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"raw"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="s2">"reported"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"raw"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{</span><span class="se">\"</span><span class="s2">v</span><span class="se">\"</span><span class="s2">:34,</span><span class="se">\"</span><span class="s2">a</span><span class="se">\"</span><span class="s2">:24}"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="s2">"delta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"raw"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>As you can read in the above example, there are three main keys:</p>
<ul>
  <li>‚Äúdesired‚Äù: It contains the desired state sent from the MQTT.fx</li>
  <li>‚Äúreported‚Äù: It contains the status information reported by the device</li>
  <li>‚Äúdelta‚Äù: It contains the differences between the reported status and the desired status. 
This is the information that is published in the delta topic.</li>
</ul>

<p><a href="#table-of-contents"><img src="pictures/utils/arrow_up.png" alt="pic" /></a></p>

<h2 id="test-your-certificates-with-mqttfx">Test your Certificates with MQTT.fx</h2>

<p>One of the best ways to make sure that certificates had been created correctly, it is to try connecting via a 
MQTT client with graphical interface.</p>

<p>We recommend you download MQTT.fx from the following link https://mqttfx.jensd.de/</p>

<ol>
  <li>Open MQTT.fx and create a new connection.</li>
</ol>

<p><img src="pictures/MQTT/MQTTFX_open.png" alt="pic" /></p>

<ol>
  <li>Configure the broker as shown in the image below.
Remember to use the files you downloaded in the previous step. And configure the broker address associated to your device.</li>
</ol>

<p><img src="pictures/MQTT/MQTTFX_Broker_Connect.png" alt="pic" /></p>

<ol>
  <li>Now that you are connected to the broker, you need to subscribe to the topics accepted and rejected.</li>
</ol>

<p>When a message is published, 
you can check in these topics if the message has been <strong>accepted</strong> or <strong>rejected</strong>.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$aws/things/MyDevice/shadow/update/accepted
$aws/things/MyDevice/shadow/update/rejected
</code></pre></div></div>

<p><img src="pictures/MQTT/MQTTFX_Topic_Subscribe_Device.png" alt="pic" /></p>

<ol>
  <li>To update your device‚Äôs shadow, you should publish in the topic the following <strong>json file</strong>, 
you can use the following link to validate it https://jsonlint.com/</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "state": {
        "reported" : { 
            "voltage" : 22
        }
    }
}
</code></pre></div></div>
<p>This example simulates the publication of voltage measurements made by the device.</p>

<p><img src="pictures/AWS/AWS_Console_Manage_Things_Details_Shadow_Device.png" alt="pic" /></p>

<ol>
  <li>Select the topic to update your shadow.
Be sure to select the service quality level as QoS 0, amazon doesn‚Äôt allow different police.
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$aws/things/MyDevice/shadow/update
</code></pre></div>    </div>
  </li>
</ol>

<p><img src="pictures/MQTT/MQTTFX_Topic_Publish_Device.png" alt="pic" /></p>

<ol>
  <li>If you want to delete the shadow‚Äôs document publish the next <strong>json file</strong>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
 "state": null
}
</code></pre></div>    </div>
  </li>
  <li>Play with this, sending different values until you understand how it works.</li>
</ol>

<p>üëç
Remember to check if your values has been accepted or rejected</p>

<p><a href="#table-of-contents"><img src="pictures/utils/arrow_up.png" alt="pic" /></a></p>

<h1 id="how-to-start-with-the-project">How to Start with the project</h1>

<p>We will explain it to you later in detail. but in this tutorial,
first you need to be familiar with the following concepts</p>

<ul>
  <li>Run a code file on your Arduino Board</li>
  <li>Run a python code</li>
  <li>Use MQTT.fx to post messages in a topic</li>
  <li>Review the shadow from AWS core</li>
</ul>

<p>Now you can connect to the internet and send your data through the UDP protocol.</p>

<p><a href="#table-of-contents"><img src="pictures/utils/arrow_up.png" alt="pic" /></a></p>

<h2 id="arduino-board-run-a-code-file">Arduino Board: Run a code file</h2>

<p>For this Arduino project, it is necessary that you include some of the files that we have exclusively prepared 
for this tutorial.</p>

<p>To do this, be sure to open the <strong>.ino</strong> file from the following 
<a href="https://github.com/telefonicaid/iot-activation/tree/master/scripts/Arduino/Connection_UDP_command">folder</a>. 
There are all the files that you will need.</p>

<p>In the following code you can check the main structure of the program:</p>
<ol>
  <li>Measuring</li>
  <li>Modem connection to the network</li>
  <li>Sending of the measures</li>
  <li>Disconnection of the modem to reduce power consumption</li>
  <li>Sampling timeout</li>
</ol>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">}</span>

<span class="kt">void</span> <span class="n">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// put your main code here, to run repeatedly:</span>
    
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"measuring..."</span><span class="p">);</span>
  <span class="n">data</span><span class="p">.</span><span class="n">measurement</span><span class="p">();</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"- voltage: "</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">get_voltage</span><span class="p">());</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"- amperage: "</span><span class="p">);</span> 
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">get_amperage</span><span class="p">());</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Sending... "</span><span class="p">);</span>     
  <span class="n">nbAccess</span><span class="p">.</span><span class="n">noLowPowerMode</span><span class="p">();</span>
  <span class="n">send_data_UDP</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">get_voltage</span><span class="p">(),</span><span class="n">data</span><span class="p">.</span><span class="n">get_amperage</span><span class="p">());</span> 
  <span class="n">nbAccess</span><span class="p">.</span><span class="n">lowPowerMode</span><span class="p">();</span>
  
  <span class="n">delay</span><span class="p">(</span><span class="n">polling</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>But first of all, don‚Äôt forget to complete the configuration 
<a href="https://github.com/telefonicaid/iot-activation/blob/master/scripts/Arduino/Connection_UDP_command/configuration.h">file</a></p>

<p>You have to complete necessary information to connect to the UDP server.</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// COMPLETE your information</span>
<span class="cp">#define SECRET_PINNUMBER ""
</span>
<span class="cp">#define LOCAL_PORT 4114
#define IP_ADDRESS "XX.XX.XX.XX"
</span>
<span class="c1">// SET your sampling time</span>
<span class="cp">#define POLL_TIME 10
</span>
</code></pre></div></div>
<p><a href="#table-of-contents"><img src="pictures/utils/arrow_up.png" alt="pic" /></a></p>

<h2 id="udp-data-bridge-connecting-using-nb-iot-o-lte-m">UDP data Bridge: Connecting using NB-IoT o LTE-M</h2>

<p>One of the advantages of an iot device, is to be able to stop the connection when it is not necessary.
This option decrease the energy consumption. So, we suggest you, the deployment of a data bridge between the Arduino and the 
AWS IoT Core.</p>

<p>Data Bridge will help you with the connection between UDP devices and the public clouds.
After the bridge deployment, it will gather your SIM information from KIte platform.
The data bridge recognizes the SIM and automatically and connects to the corresponding 
AWS MQTT broker based on the configuration you provide it.</p>

<p>You just make sure to add the name of the thing as one of the fields of the SIM in Kite.
<a href="KitePlatform.html#sim-identification">Kite</a></p>

<p>This <a href="BPDataBridge.html">bridge</a>
is the easiest way to connect to AWS using only one UDP send</p>

<p>üìç
If you‚Äôre running the connection tests in The Thinx lab.
The SIM you use will not have connectivity with the Kite platform.
So you will not be able to use the connection through our Bridge. 
Even so you have access to the internet and you will be able to perform any test on your infrastructure.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"################################# waiting for a new message #################################"</span><span class="p">)</span>
 <span class="n">udp_msg</span><span class="p">,</span> <span class="n">udp_ip</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
 <span class="n">ip</span> <span class="o">=</span> <span class="n">udp_ip</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

 <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Message Received [ </span><span class="si">%</span><span class="s">s ] from [ </span><span class="si">%</span><span class="s">s ] : [ </span><span class="si">%</span><span class="s">s ]"</span> <span class="o">%</span> <span class="p">(</span><span class="n">udp_msg</span><span class="p">,</span> <span class="n">udp_ip</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">udp_ip</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">))</span>

 <span class="n">response</span> <span class="o">=</span> <span class="n">bridge_routine</span><span class="p">(</span><span class="n">udp_msg</span><span class="p">,</span> <span class="n">udp_ip</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">config_cloud</span><span class="p">)</span>

 <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">"Generate ACK payload [ </span><span class="si">%</span><span class="s">s ]"</span> <span class="o">%</span> <span class="n">response</span><span class="p">)</span>
 <span class="n">ack_msg</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

 <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Sent MESSAGE [ </span><span class="si">%</span><span class="s">s ] to [ </span><span class="si">%</span><span class="s">s ] : [ </span><span class="si">%</span><span class="s">s ]"</span> <span class="o">%</span> <span class="p">(</span><span class="n">ack_msg</span><span class="p">,</span> <span class="n">udp_ip</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">udp_ip</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
 <span class="n">sock</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">ack_msg</span><span class="p">,</span> <span class="n">udp_ip</span><span class="p">)</span>
</code></pre></div></div>

<p><a href="#table-of-contents"><img src="pictures/utils/arrow_up.png" alt="pic" /></a></p>

<h2 id="check-the-shadow">Check the Shadow</h2>

<p>Before starting the execution you will check how your shadow is empty. 
With this Arduino script you can send voltage and current values to the shadow.
The shadow will be updated with every message received from the device.</p>

<p><a href="#table-of-contents"><img src="pictures/utils/arrow_up.png" alt="pic" /></a></p>

<h2 id="send-a-command">Send a command</h2>

<p>To send a command to the device, you must use the MQTT as explained in the previous section through the json that we provide you.
You can change this instruction as many times as needed.</p>

<p>In this example you can turn on and off the small LED on the board, but you are unrestricted to program
your own instructions. Feel free!</p>

<ul>
  <li>Turn on led
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"state"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"desired"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"raw"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
      </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>Turn off led
```json
{
  ‚Äústate‚Äù: {
      ‚Äúdesired‚Äù: {
          ‚Äúraw‚Äù: 2
      }</li>
</ul>

<p>```</p>

<p><a href="#table-of-contents"><img src="pictures/utils/arrow_up.png" alt="pic" /></a></p>


	  	</article>
	  	
	  	
	  	
<!-- Output author details if some exist. -->
   

    <!--ul class="pager">
      
      <li class="previous"><a class="basic-alignment left"
        href="iot-activation/SSHEthernet.html" title="Previous Post:
        Control your Raspberry with a Network cable">&laquo; Control your Raspberry with a Network cable</a></li>
      
      <li><a href="/blog/archives">Blog Archives</a></li>
      
      <li class="next"><a class="basic-alignment right" 
	    href="iot-activation/ArduinoGCP.html" title="Next Post: 
		Arduino to Google Cloud">Arduino to Google Cloud
        &raquo;</a></li>
      
    </ul-->
	</div>
	<div class="col-md-1"></div>
</div>
    </div>
    <div class="col-md-12 share-div">
        <div class="col-md-1"></div>
        <div class="col-md-10">
          
<div class="fb_share">
	<div id="fb-root"></div>
	<script>(function(d, s, id) {
	  var js, fjs = d.getElementsByTagName(s)[0];
	  if (d.getElementById(id)) return;
	  js = d.createElement(s); js.id = id;
	  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&appId=354997024639145&version=v2.0";
	  fjs.parentNode.insertBefore(js, fjs);
	}(document, 'script', 'facebook-jssdk'));</script>
<div class="fb-share-button" data-layout="button_count"></div>
</div>



<div class="twitter_share">
	<a href="https://twitter.com/share" class="twitter-share-button" data-via="TelefonicaIoT" data-hashtags="sailsjs">Tweet</a>
	<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>



<div class="linkedin_share">
	<script src="//platform.linkedin.com/in.js" type="text/javascript">
	  lang: en_US
	</script>
	<script type="IN/Share" data-counter="right"></script>
</div>



        </div>
        <div class="col-md-1"></div>
    </div>
    <div class="col-md-12">
    
    </div>
    <div class="col-md-12">
    			<div class="row end_footer">
              <div class="col-md-1"></div>
              <div class="col-md-6">
                
              </div>
              <div class="col-md-4"></div>
              <div class="col-md-1"></div>
            </div>
    </div>
        <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/prettify.js"></script>
    <script>
      [].forEach.call(document.getElementsByTagName("pre"), function(el) {
        el.classList.add("prettyprint");
      });

      prettyPrint();
    </script>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', '']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>

    <style>
      pre.prettyprint {

        font-size: 13px;
        font-family: "Open Sans";
        padding: 8px 12px;
        border: 1px solid #bbb;
        border-radius: 4px;
      }
    </style>

  </body>

</html>
